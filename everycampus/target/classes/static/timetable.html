<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>시간표 관리</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 40px 20px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #4263eb;
      color: white;
    }

    td[contenteditable="true"] {
      background-color: #f9f9f9;
    }

    .button-container {
      margin-top: 20px;
      text-align: center;
    }

    button {
      padding: 10px 20px;
      background-color: #4263eb;
      border: none;
      color: white;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background-color: #364fc7;
    }

    .home-button {
      background-color: #28a745;
    }

    .home-button:hover {
      background-color: #218838;
    }
	td.clickable {
	  cursor: pointer;
	  transition: background-color 0.2s ease, box-shadow 0.2s ease;
	}
	
	td.clickable:hover {
	  background-color: #e8f0fe;
	  box-shadow: inset 0 0 5px #4263eb;
	}
.time-cell {
  position: relative;
}

.delete-btn {
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  background: red;
  color: white;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  display: none;
}

.time-cell:hover .delete-btn {
  display: inline-block;
}

  </style>
</head>
<body>
  <h2>나의 시간표</h2>

<table id="timetable-table">
  <thead>
    <tr>
      <th>시간</th>
      <th>월</th>
      <th>화</th>
      <th>수</th>
      <th>목</th>
      <th>금</th>
    </tr>
  </thead>
  <tbody>
    <!-- 여기 내용은 JS로 채워짐 -->
  </tbody>
</table>



  <div class="button-container">
    <button onclick="loadTimetableFromServer()">시간표 불러오기</button>
    <button onclick="saveTimetableToServer()">시간표 저장</button>
      <button onclick="addCustomRow()">30분 단위 행 추가</button>
    <button class="home-button" onclick="goHome()">홈 화면</button>
  </div>

  <script>
    let timetableData = [];

    function initTimetable() {
    	  timetableData = [];
    	  for (let hour = 9; hour <= 17; hour++) {
    	    timetableData.push({
    	      time: `${hour.toString().padStart(2, "0")}:00 - ${(hour + 1).toString().padStart(2, "0")}:00`,
    	      mon: "", tue: "", wed: "", thu: "", fri: ""
    	    });
    	  }
    	}

    function addCustomRow() {
    	  const timeOptions = [
    	    "08:00 - 08:30", "08:30 - 09:00",
    	    "09:00 - 09:30", "09:30 - 10:00",
    	    "10:00 - 10:30", "10:30 - 11:00",
    	    "11:00 - 11:30", "11:30 - 12:00",
    	    "12:00 - 12:30", "12:30 - 13:00",
    	    "13:00 - 13:30", "13:30 - 14:00",
    	    "14:00 - 14:30", "14:30 - 15:00",
    	    "15:00 - 15:30", "15:30 - 16:00",
    	    "16:00 - 16:30", "16:30 - 17:00"
    	  ];

    	  const newRow = {
    	    time: "",  // 나중에 select에서 선택
    	    mon: "", tue: "", wed: "", thu: "", fri: ""
    	  };

    	  timetableData.push(newRow);
    	  renderTimetable(true); // 커스텀 행 표시
    	}


    function renderTimetable(showSelect = false) {
    	  const tbody = document.querySelector("#timetable-table tbody");
    	  tbody.innerHTML = "";

    	  timetableData.forEach((row, i) => {
    	    const tr = document.createElement("tr");

    	    const timeCell = showSelect && row.time === ""
    	      ? `<td class="time-cell">
    	           <select onchange="updateTime(${i}, this.value)">
    	             <option value="">시간 선택</option>
    	             ${[
    	               "08:00 - 08:30", "08:30 - 09:00", "09:00 - 09:30", "09:30 - 10:00",
    	               "10:00 - 10:30", "10:30 - 11:00", "11:00 - 11:30", "11:30 - 12:00",
    	               "12:00 - 12:30", "12:30 - 13:00", "13:00 - 13:30", "13:30 - 14:00",
    	               "14:00 - 14:30", "14:30 - 15:00", "15:00 - 15:30", "15:30 - 16:00",
    	               "16:00 - 16:30", "16:30 - 17:00", "17:00 - 17:30", "17:30 - 18:00"
    	             ].map(t => `<option value="${t}">${t}</option>`).join("")}
    	           </select>
    	         </td>`
    	      : `<td class="time-cell">
    	           ${row.time}
    	           <button class="delete-btn" onclick="removeRow(${i})">🗑️</button>
    	         </td>`;

    	    tr.innerHTML = `
    	      ${timeCell}
    	      <td class="clickable" contenteditable="true"
    	          onclick="goToReview(this.innerText)"
    	          oninput="updateTimetable(${i}, 'mon', this.innerText)">
    	          ${row.mon}
    	      </td>
    	      <td class="clickable" contenteditable="true"
    	          onclick="goToReview(this.innerText)"
    	          oninput="updateTimetable(${i}, 'tue', this.innerText)">
    	          ${row.tue}
    	      </td>
    	      <td class="clickable" contenteditable="true"
    	          onclick="goToReview(this.innerText)"
    	          oninput="updateTimetable(${i}, 'wed', this.innerText)">
    	          ${row.wed}
    	      </td>
    	      <td class="clickable" contenteditable="true"
    	          onclick="goToReview(this.innerText)"
    	          oninput="updateTimetable(${i}, 'thu', this.innerText)">
    	          ${row.thu}
    	      </td>
    	      <td class="clickable" contenteditable="true"
    	          onclick="goToReview(this.innerText)"
    	          oninput="updateTimetable(${i}, 'fri', this.innerText)">
    	          ${row.fri}
    	      </td>
    	    `;
    	    tbody.appendChild(tr);
    	  });
    	}




    function updateTimetable(index, day, value) {
      timetableData[index][day] = value;
    }

    function getDayKey(day) {
    	  return {
    	    "Mon": "mon", "Tue": "tue", "Wed": "wed", "Thu": "thu", "Fri": "fri"
    	  }[day];
    	}
    
    function goToReview(subject) {
    	  if (subject && subject.trim() !== "") {
    	    const encoded = encodeURIComponent(subject.trim());
    	    window.location.href = `/review/lecture?name=${encoded}`;
    	  }
    	}

    function loadTimetableFromServer() {
    	  const studentId = localStorage.getItem("username") || "guest";
    	  fetch(`/api/timetable/load/${studentId}`)
    	    .then(res => {
    	      if (!res.ok) {
    	        throw new Error(`시간표를 불러올 수 없습니다. (status: ${res.status})`);
    	      }
    	      return res.json();
    	    })
    	    .then(data => {
    	      initTimetable();
    	      data.forEach(entry => {
    	        const row = timetableData.find(r => r.time === entry.timeSlot);
    	        const key = getDayKey(entry.dayOfWeek);
    	        if (row && key) {
    	          row[key] = entry.subject || "";
    	        }
    	      });
    	      renderTimetable();
    	    })
    	    .catch(err => {
    	      alert(err.message);  // ❗ 사용자에게 오류 안내
    	    });
    	}
	    function updateTime(index, value) {
	    	  timetableData[index].time = value;
	    	  sortTimetable();
	    	  renderTimetable(true);
	    	}
	
	    function removeRow(index) {
	    	  timetableData.splice(index, 1);
	    	  renderTimetable(true);
	    	}


    	function sortTimetable() {
    	  timetableData.sort((a, b) => {
    	    if (!a.time || !b.time) return 0;
    	    return a.time.localeCompare(b.time);
    	  });
    	}


    function saveTimetableToServer() {
      const studentId = localStorage.getItem("username") || "guest";
      fetch('/api/timetable/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          studentId: studentId,
          timetable: timetableData
        })
      }).then(res => {
        if (res.ok) alert("시간표 저장 완료!");
        else alert("저장 실패");
      });
    }

    function goHome() {
      window.location.href = "/main.html";  // 올바른 홈 화면 경로로 리디렉션
    }

    // 시작 시 로딩
    document.addEventListener("DOMContentLoaded", () => {
      initTimetable();
      renderTimetable();
      loadTimetableFromServer();
    });
  </script>
</body>
</html>
